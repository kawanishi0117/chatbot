# ユーザープロファイル編集機能

このドキュメントでは、新しく実装されたユーザープロファイル編集機能について説明します。

## 概要

ユーザーは自分のプロファイル情報（メールアドレス、名前、パスワード）を編集できるようになりました。この機能は以下の2つのフロントエンドアプリケーションで利用可能です：

- `frontend/chatbot-ui` - チャットボットユーザーインターフェース
- `frontend/chatbot-console` - 管理者コンソール

## 実装された機能

### バックエンド

#### 新しいAPIエンドポイント
- **PUT /api/auth/profile** - ユーザープロファイル更新

#### 機能詳細
- メールアドレス、名前、パスワードの更新をサポート
- 登録時と同じバリデーションルールを適用
- メールアドレス変更時の適切な処理（古いレコード削除、新しいレコード作成）
- セッション情報の自動更新
- userIdは編集不可（仕様通り）

#### データベース構造
- PK: `USER#{email}`
- SK: `PROFILE`
- メールアドレス変更時は古いレコードを削除し、新しいレコードを作成

### フロントエンド

#### 新しいコンポーネント
- `ProfileEdit.tsx` - プロファイル編集モーダル（両アプリケーション）

#### UI機能
- ヘッダーにプロファイル編集ボタンを追加
- モーダル形式でのプロファイル編集
- リアルタイムバリデーション
- パスワード表示/非表示切り替え
- ローディング状態の表示
- エラーハンドリング

## 使用方法

### ユーザー向け

1. **chatbot-ui**:
   - ヘッダーの右側にあるユーザーアイコンをクリック
   - プロファイル編集モーダルが開きます

2. **chatbot-console**:
   - ヘッダーの右側にある編集アイコンをクリック
   - プロファイル編集モーダルが開きます

3. **編集可能な項目**:
   - メールアドレス
   - 名前
   - パスワード（変更する場合のみ入力）

### バリデーションルール

- **メールアドレス**: 有効な形式である必要があります（@を含み、5文字以上）
- **名前**: 必須項目です（空文字不可）
- **パスワード**: 6文字以上（変更する場合のみ）
- **パスワード確認**: パスワードと一致する必要があります

## API仕様

### PUT /api/auth/profile

**リクエスト**:
```json
{
  "email": "new@example.com",    // オプション
  "name": "New Name",           // オプション
  "password": "newpassword123"  // オプション
}
```

**レスポンス**:
```json
{
  "PK": "USER#new@example.com",
  "SK": "PROFILE",
  "userId": "uuid-string",
  "email": "new@example.com",
  "name": "New Name",
  "role": "user",
  "createdAt": 1640995200000,
  "updatedAt": 1640995200000,
  "isActive": true
}
```

**エラーレスポンス**:
- 400: バリデーションエラー
- 401: 認証エラー
- 409: メールアドレス重複
- 500: サーバーエラー

## テスト

### バックエンドテスト
```bash
cd backend/chat-router
python -m pytest test_user_handler.py -v
```

### フロントエンドテスト
```bash
# chatbot-ui
cd frontend/chatbot-ui
npm test ProfileEdit.test.tsx

# chatbot-console
cd frontend/chatbot-console
npm test ProfileEdit.test.tsx
```

## セキュリティ考慮事項

1. **認証**: すべてのプロファイル更新にはJWTトークンが必要
2. **パスワードハッシュ化**: パスワードはSHA-256でハッシュ化して保存
3. **メールアドレス重複チェック**: 既存のメールアドレスとの重複を防止
4. **セッション管理**: メールアドレス変更時にセッション情報を適切に更新

## 注意事項

1. **メールアドレス変更**: メールアドレスを変更すると、DynamoDBの主キーが変更されるため、古いレコードが削除され新しいレコードが作成されます
2. **セッション継続**: メールアドレス変更後もセッションは継続されます
3. **userId不変**: userIdは編集できません（仕様通り）
4. **バリデーション一貫性**: 登録時と同じバリデーションルールが適用されます

## トラブルシューティング

### よくある問題

1. **メールアドレス重複エラー**:
   - 他のユーザーが既に使用しているメールアドレスに変更しようとした場合
   - 解決方法: 別のメールアドレスを使用してください

2. **セッション期限切れ**:
   - 長時間操作しなかった場合
   - 解決方法: 再ログインしてください

3. **バリデーションエラー**:
   - 入力値が要件を満たしていない場合
   - 解決方法: エラーメッセージに従って入力を修正してください

## 今後の改善予定

1. パスワードハッシュ化アルゴリズムの強化（bcryptの使用）
2. メールアドレス変更時の確認メール送信
3. プロファイル変更履歴の記録
4. 2要素認証の追加