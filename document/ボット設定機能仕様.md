# 🤖 ボット設定機能仕様書 v2

---

## 1. 概要とゴール

* **マルチテナント対応** - 複数のボット設定を管理できるシステム（✅ 実装済み）
* **一意性保証** - UUID ベースのボット識別子で重複を防止（✅ 実装済み）
* **作成者管理** - ボット作成者の追跡とアクセス制御（✅ 実装済み）
* **柔軟な説明管理** - ボットの目的や機能を記述可能（✅ 実装済み）
* **フロントエンド・バックエンド統合** - React UI と Lambda API の連携（✅ 実装済み）
* **権限管理** - owner/admin/member のロールベースアクセス制御（✅ 実装済み）
* **招待機能** - 有効期限付き招待リンクによるユーザー追加（✅ 実装済み）

---

## 2. 📊 データモデル設計

### 2.1 ボット設定（DynamoDB - ChatbotSettingsDB）

**テーブル名**: `ChatbotSettingsDB-dev`

#### ボット設定レコード

| 属性名        | 型    | 説明                                    | 例                                        |
|---------------|-------|----------------------------------------|-------------------------------------------|
| **PK**        | `S`   | `BOT#<botId>` - パーティションキー      | `BOT#550e8400-e29b-41d4-a716-446655440000`|
| **SK**        | `S`   | 固定値 `CONFIG` - ソートキー            | `CONFIG`                                  |
| `botId`       | `S`   | ボットID（UUID）                       | `550e8400-e29b-41d4-a716-446655440000`   |
| `botName`     | `S`   | ボット名                               | `サポートボット`                           |
| `description` | `S`   | ボットの説明                           | `技術的な質問に回答するサポートボットです` |
| `creatorId`   | `S`   | 作成者のユーザーID（メールアドレス）    | `admin@example.com`                       |
| `createdAt`   | `S`   | 作成日時（ISO 8601形式）               | `2024-01-01T00:00:00Z`                   |
| `updatedAt`   | `S`   | 更新日時（ISO 8601形式）               | `2024-01-01T00:00:00Z`                   |
| `isActive`    | `BOOL`| アクティブ状態                         | `true`                                    |

#### ボットアクセス権限レコード

| 属性名        | 型    | 説明                                    | 例                                        |
|---------------|-------|----------------------------------------|-------------------------------------------|
| **PK**        | `S`   | `BOT#<botId>` - パーティションキー      | `BOT#550e8400-e29b-41d4`                 |
| **SK**        | `S`   | `ACCESS#<userId>` - ソートキー          | `ACCESS#user@example.com`                 |
| `userId`      | `S`   | ユーザーID（メールアドレス）            | `user@example.com`                        |
| `role`        | `S`   | ロール（owner/admin/member）           | `member`                                  |
| `grantedAt`   | `S`   | 権限付与日時（ISO 8601形式）           | `2024-01-01T00:00:00Z`                   |
| `grantedBy`   | `S`   | 権限付与者のユーザーID                 | `admin@example.com`                       |

### 2.2 インデックス設計

現在の実装では、GSI（グローバルセカンダリインデックス）は使用せず、Scanオペレーションでボット一覧を取得しています。
将来的な最適化として、以下のGSIの追加を検討：

**GSI1**: `creatorId-createdAt-index`（未実装）
- **GSI1PK**: `creatorId`
- **GSI1SK**: `createdAt`
- 用途: 特定のユーザーが作成したボット一覧の効率的な取得

---

## 3. 🔄 API設計（実装済み）

### 3.1 ボット作成 API

```http
POST /api/bots
Content-Type: application/json
Authorization: Bearer <token>

{
  "botName": "サポートボット",
  "description": "技術的な質問に回答するサポートボットです"
}
```

**レスポンス例**:
```json
{
  "success": true,
  "data": {
    "botId": "550e8400-e29b-41d4-a716-446655440000",
    "botName": "サポートボット",
    "description": "技術的な質問に回答するサポートボットです",
    "creatorId": "admin@example.com",
    "createdAt": "2024-01-01T00:00:00Z",
    "updatedAt": "2024-01-01T00:00:00Z",
    "isActive": true,
    "role": "owner"
  }
}
```

### 3.2 ボット一覧取得 API

```http
GET /api/bots
Authorization: Bearer <token>
```

**レスポンス**: ユーザーがアクセス権を持つボットのみ返却

### 3.3 ボット詳細取得 API

```http
GET /api/bots/{botId}
Authorization: Bearer <token>
```

### 3.4 ボット更新 API

```http
PUT /api/bots/{botId}
Content-Type: application/json
Authorization: Bearer <token>

{
  "botName": "更新されたボット名",
  "description": "更新された説明",
  "isActive": false
}
```

### 3.5 ボット削除 API

```http
DELETE /api/bots/{botId}
Authorization: Bearer <token>
```

### 3.6 ボットユーザー管理 API（実装済み）

#### ユーザー一覧取得
```http
GET /api/bots/{botId}/users
Authorization: Bearer <token>
```

#### 招待作成
```http
POST /api/bots/{botId}/invite
Content-Type: application/json
Authorization: Bearer <token>

{
  "role": "member",
  "expiresIn": 86400  // 秒単位（デフォルト: 24時間）
}
```

#### ユーザー権限更新
```http
PUT /api/bots/{botId}/users/{userId}
Content-Type: application/json
Authorization: Bearer <token>

{
  "role": "admin"
}
```

#### ユーザー削除
```http
DELETE /api/bots/{botId}/users/{userId}
Authorization: Bearer <token>
```

---

## 4. 🛡️ セキュリティ・認証（実装済み）

### 4.1 アクセス制御

| 操作               | 権限要件                                |
|-------------------|----------------------------------------|
| ボット作成         | 認証済みユーザー                       |
| ボット読み取り     | ボットのアクセス権を持つユーザー       |
| ボット更新         | owner または admin                     |
| ボット削除         | owner のみ                             |
| ユーザー管理       | owner または admin                     |
| メッセージ送受信   | member 以上                            |

### 4.2 ロール定義

- **owner**: すべての権限（削除含む）
- **admin**: ユーザー管理、ボット設定変更
- **member**: メッセージの送受信のみ

### 4.3 バリデーション（実装済み）

- **ボット名**: 1-100文字
- **説明**: 0-500文字
- **botId**: UUID v4 形式
- **メールアドレス**: 有効なメール形式
- **パスワード**: 8文字以上

---

## 5. 🖥️ フロントエンド実装

### 5.1 コンポーネント構成（chatbot-console）

```
src/
├── components/
│   ├── bots/
│   │   ├── BotCard.tsx          # ボットカード表示
│   │   ├── BotCreateModal.tsx   # ボット作成モーダル
│   │   └── BotList.tsx          # ボット一覧
│   ├── chat/
│   │   ├── ChatInterface.tsx    # チャットUI
│   │   └── MessageList.tsx      # メッセージ一覧
│   └── users/
│       ├── UserManagement.tsx   # ユーザー管理画面
│       └── InviteModal.tsx      # 招待モーダル
└── pages/
    ├── Dashboard.tsx            # ダッシュボード
    ├── Login.tsx               # ログイン画面
    └── Register.tsx            # 登録画面
```

### 5.2 主要機能（実装済み）

- **ボット一覧表示**: カード形式での視覚的表示
- **ボット作成**: モーダルでの作成フォーム
- **チャット機能**: リアルタイムメッセージ送受信
- **ユーザー管理**: 招待リンク生成、権限変更
- **認証**: JWT ベースのセッション管理

---

## 6. ⚙️ バックエンド実装

### 6.1 Lambda関数構成（実装済み）

```
backend/chat-router/src/
├── handlers/
│   ├── bot_settings_handler.py  # ボット設定 CRUD 操作
│   ├── chat_handler.py         # チャット管理
│   ├── user_handler.py         # ユーザー管理
│   └── webhook_handler.py      # Webhook処理
├── services/
│   ├── auth_service.py         # 認証サービス
│   └── profile_service.py      # プロファイル管理
└── storage.py                  # DynamoDB操作
```

### 6.2 主要クラス・メソッド（実装済み）

```python
# bot_settings_handler.py
def create_bot(event, context)
def list_bots(event, context)
def get_bot(event, context)
def update_bot(event, context)
def delete_bot(event, context)

# user_handler.py
def list_bot_users(event, context)
def create_invitation(event, context)
def update_user_permission(event, context)
def remove_user_from_bot(event, context)
def get_invitation(event, context)
def accept_invitation(event, context)
```

---

## 7. 🔗 既存システムとの統合

### 7.1 チャットルーター連携（実装済み）

- **ボットID による識別**: チャットメッセージ処理時にボット設定を参照
- **権限チェック**: メッセージ送信前にユーザーのボットアクセス権を確認
- **マルチプラットフォーム対応**: Custom UI、LINE、Slack、Teams（※プラットフォーム認証は未実装）

### 7.2 将来の拡張ポイント

- **AI 連携**: Bedrock Claude との統合（未実装）
- **GitHub 連携**: Issue 検索・作成（未実装）
- **ベクトル検索**: 知識ベース検索（未実装）

---

## 8. 🚀 実装状況

### ✅ 実装済み
- [x] DynamoDB テーブル作成
- [x] 基本的な CRUD Lambda 関数
- [x] REST API エンドポイント作成
- [x] バリデーション実装
- [x] エラーハンドリング
- [x] React コンポーネント作成
- [x] API 統合
- [x] UI/UX 実装
- [x] アクセス制御実装
- [x] ユーザー管理機能
- [x] 招待機能

### ❌ 未実装
- [ ] GSI インデックス最適化
- [ ] プラットフォーム別認証（Slack/LINE/Teams）
- [ ] AI 機能統合
- [ ] 単体テスト
- [ ] 統合テスト

---

## 9. 📝 設定例（実際のデータ形式）

### 9.1 ボット設定（DynamoDB）

```json
{
  "PK": "BOT#550e8400-e29b-41d4-a716-446655440000",
  "SK": "CONFIG",
  "botId": "550e8400-e29b-41d4-a716-446655440000",
  "botName": "技術サポートボット",
  "description": "開発チーム向けの技術的な質問に回答するボットです。",
  "creatorId": "admin@example.com",
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "isActive": true
}
```

### 9.2 アクセス権限（DynamoDB）

```json
{
  "PK": "BOT#550e8400-e29b-41d4-a716-446655440000",
  "SK": "ACCESS#user@example.com",
  "userId": "user@example.com",
  "role": "member",
  "grantedAt": "2024-01-01T00:00:00Z",
  "grantedBy": "admin@example.com"
}
```

### 9.3 招待情報（DynamoDB）

```json
{
  "PK": "INVITATION#123e4567-e89b-12d3-a456-426614174000",
  "SK": "INFO",
  "invitationId": "123e4567-e89b-12d3-a456-426614174000",
  "botId": "550e8400-e29b-41d4-a716-446655440000",
  "invitedBy": "admin@example.com",
  "role": "member",
  "createdAt": "2024-01-01T00:00:00Z",
  "expiresAt": "2024-01-02T00:00:00Z",
  "usedBy": null,
  "usedAt": null
}
```

---

## 10. ☁️ AWS リソース設定（現在の実装）

### 10.1 DynamoDB テーブル設定

**テーブル名**: `ChatbotSettingsDB-dev`

- **課金モード**: オンデマンド
- **パーティションキー**: PK (String)
- **ソートキー**: SK (String)
- **TTL**: 未設定（セッション情報は手動削除）
- **ポイントインタイムリカバリ**: 推奨（未設定）

### 10.2 Lambda 関数の Environment Variables

```yaml
Environment:
  Variables:
    CHATBOT_SETTINGS_TABLE: "ChatbotSettingsDB-dev"
    CHAT_HISTORY_TABLE: "ChatHistory-dev"
    CHAT_ASSETS_BUCKET: "chat-history-assets-dev"
    TTL_SECONDS: "86400"
```

### 10.3 IAM ポリシー（実装済み）

Lambda 実行ロールに付与される権限：

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:GetItem",
        "dynamodb:PutItem",
        "dynamodb:UpdateItem",
        "dynamodb:DeleteItem",
        "dynamodb:Query",
        "dynamodb:Scan"
      ],
      "Resource": [
        "arn:aws:dynamodb:*:*:table/ChatbotSettingsDB-dev",
        "arn:aws:dynamodb:*:*:table/ChatHistory-dev"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::chat-history-assets-dev/*"
      ]
    }
  ]
}
```

---

## 11. 🔍 モニタリング・ログ

### 11.1 CloudWatch メトリクス（推奨）
- ボット作成数
- アクティブボット数
- API 呼び出し回数
- エラー率
- DynamoDB 読み取り/書き込み消費量

### 11.2 ログ項目（実装済み）
- ボット操作ログ（作成・更新・削除）
- アクセスログ
- エラーログ
- 認証試行ログ

### 11.3 アラート設定（推奨）
- API エラー率 > 5%
- Lambda 実行時間 > 10秒
- 認証失敗の連続試行

---

*最終更新: 2024年12月* 