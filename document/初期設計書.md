## 📑 全体設計書 v3 – "誰でもわかる 💬 コマンド & バイリンガル対応版"

---

### 1. ゴールとコンセプト

* **マルチチャネル（LINE / Slack / Teams / Custom UI）** で同じコードを使える"問い合わせボット"
* **GitHub Issues & ドキュメント**を検索して即回答。未知の不具合は自動で Issue 化 ➜ AI PR まで自走（※未実装）
* ユーザーが **かんたんコマンド（日本語/英語両対応）** でセッションを開始・調査・終了できる
* 💰 **月数十ドル**で回るコスト最適アーキテクチャ
* ⏱️ 体感レスポンス < 1 秒（ACK）を維持
* 🔐 **マルチテナント対応** - 複数のボット設定を管理し、ユーザー認証・権限管理を実装

---

### 2. 💬 コマンド設計（バイリンガル・ヒアリング型）

| 機能                               | 英語コマンド | 日本語コマンド | 送信例                                                                          | 挙動                                                                                                                   |
| ---------------------------------- | ------------ | -------------- | ------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| 新規問い合わせ開始＋ヒアリング開始 | `/ask`       | `/質問`        | `/ask Unable to push image to ECR`<br>`/質問 Podman で BuildKit を有効にしたい` | 新しい **セッション ID** を発行し、直後に不足情報を bot が順次ヒアリングするフェーズへ入る。（※ヒアリング機能は未実装）     |
| ヒアリング強制終了（任意）         | `/done`      | `/完了`        | `/done`                                                                         | 途中でもユーザーが十分な情報を入力したと判断した場合に送信。ヒアリングを打ち切り、直ちに調査・回答生成フェーズへ移行。（※未実装） |
| 追加メッセージ（同一スレッド）     | ― *自動*     | ― *自動*       | 通常のメッセージ送信                                                            | チャット履歴に保存され、会話の継続が可能。                                                                               |
| セッション削除                     | `/clear`     | `/クリア`      | `/clear`                                                                        | 会話ログと関連ベクトルを即時削除し、「セッションを削除しました 🗑️」と応答。（※未実装）                                    |
| ヘルプ                             | `/help`      | `/ヘルプ`      | `/help`                                                                         | 現在利用できるコマンド一覧（日英併記）を送信。（※未実装）                                                                |

> *LINE ではコマンドの前に「@ボット名」を付ける、Teams では `@Bot /質問 …` など各プラットフォームの慣習的呼び方も許容。*


---

### 3. アーキテクチャ (現在の実装版)

```
LINE / Slack / Teams / Custom UI  ← Webhook
        │
API Gateway (REST API)
        │
ChatRouter Lambda (Python 3.12)
  ├─ webhook_handler.py   (各プラットフォーム処理)
  ├─ auth_service.py      (認証・セッション管理)
  ├─ bot_settings_handler.py (ボット設定CRUD)
  ├─ chat_handler.py      (チャット管理)
  ├─ user_handler.py      (ユーザー管理)
  └─ storage.py           (DynamoDB操作)

データストレージ:
  ├─ ChatHistory (DynamoDB)        - メッセージ履歴
  ├─ ChatbotSettingsDB (DynamoDB)  - ボット設定、ユーザー、チャット情報
  └─ chat-history-assets (S3)      - バイナリデータ

※ 以下は未実装:
  - EventBridge → Step Functions Express
  - RetrieveLambda (Docs + Chat RAG)
  - DecideActionLambda (Claude3.5 Haiku)
  - SummarizeLambda
  - VectorStore (DynamoDB Vector Search)
  - GitHub連携
```

#### 主要 AWS サービス & 理由

| レイヤ       | サービス                                         | コスト/理由                   |
| ------------ | ------------------------------------------------ | ----------------------------- |
| HTTP 入口    | **API Gateway (REST API)**                       | 1 M 呼び出し ≒ \$3.5          |
| 即時処理     | **Lambda (256 MB)**                              | Cold start < 150 ms           |
| 会話ログ     | **DynamoDB (ChatHistory)**                       | on-demand、TTL 24時間         |
| 設定・ユーザー | **DynamoDB (ChatbotSettingsDB)**                | on-demand                     |
| バイナリ保存  | **S3 (chat-history-assets)**                    | 画像・ファイル保存            |
| Secrets      | **環境変数**（※本番では Secrets Manager 推奨）   | Channel Token等               |

---

### 4. データモデル

#### 4.1 `ChatHistory` テーブル

| PK             | SK              | 属性                      | 用途                                  |
| -------------- | --------------- | ------------------------- | ------------------------------------- |
| `<room_key>`   | `<timestamp>`   | role, contentType, text, s3Uri, ttl | 時系列メッセージ保存                  |

* **room_key**: プラットフォーム固有のルーム識別子（例: `slack:C1234567890`, `custom:550e8400-e29b-41d4`）
* **timestamp**: 19桁の0パディングされたミリ秒タイムスタンプ
* **TTL**: 24時間（86400秒）で自動削除
* **contentType**: text, image, file等
* **s3Uri**: バイナリデータがある場合のS3パス

#### 4.2 `ChatbotSettingsDB` テーブル

##### ボット設定
| PK             | SK         | 属性                                    |
| -------------- | ---------- | --------------------------------------- |
| `BOT#<botId>`  | `CONFIG`   | botName, description, creatorId, createdAt, updatedAt, isActive |

##### ユーザー情報
| PK             | SK         | 属性                                    |
| -------------- | ---------- | --------------------------------------- |
| `USER#<email>` | `PROFILE`  | email, name, hashedPassword, createdAt, updatedAt |

##### セッション情報
| PK                    | SK     | 属性                                    |
| --------------------- | ------ | --------------------------------------- |
| `SESSION#<token>`     | `INFO` | email, createdAt, ttl                   |

##### チャットルーム
| PK              | SK             | 属性                                    |
| --------------- | -------------- | --------------------------------------- |
| `USER#<userId>` | `CHAT#<chatId>` | chatId, userId, title, botId, botName, createdAt, updatedAt, messageCount, lastMessage, isActive |

##### ボットアクセス権限
| PK                | SK                | 属性                                    |
| ----------------- | ----------------- | --------------------------------------- |
| `BOT#<botId>`     | `ACCESS#<userId>` | userId, role, grantedAt, grantedBy      |

##### 招待情報
| PK                        | SK         | 属性                                    |
| ------------------------- | ---------- | --------------------------------------- |
| `INVITATION#<invitationId>` | `INFO`     | botId, invitedBy, role, createdAt, expiresAt, usedBy, usedAt |

---

### 5. コマンドフロー詳細（現在の実装）

| ステップ                    | 詳細                                                                                                                                                                                     | 主要コンポーネント                           |
| --------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------- |
| **5-1. メッセージ受信**     | 1) 各プラットフォームからWebhook受信<br>2) webhook_handler.pyで正規化<br>3) UnifiedMessageとしてChatHistoryに保存                                                                        | webhook_handler / storage.py                 |
| **5-2. 認証処理**           | 1) Custom UIの場合はJWT認証<br>2) auth_service.pyでセッション管理<br>3) ユーザー情報の取得・検証                                                                                         | auth_service.py                              |
| **5-3. チャット管理**       | 1) chat_handler.pyでチャットルームの作成・取得<br>2) メッセージ履歴の管理<br>3) ChatbotSettingsDBにチャット情報保存                                                                     | chat_handler.py / DynamoDBManager            |
| **5-4. ボット設定管理**     | 1) bot_settings_handler.pyでCRUD操作<br>2) マルチテナント対応<br>3) アクセス権限管理                                                                                                    | bot_settings_handler.py                      |
| **5-5. レスポンス返却**     | 1) 各プラットフォーム向けのレスポンス生成<br>2) Custom UIはJSON、他はプラットフォーム固有形式                                                                                            | webhook_handler.py                           |

#### 💡 未実装機能

* **AI連携**: Bedrock Claude、ベクトル検索、RAG
* **ヒアリング機能**: Step Functions によるインタラクティブな情報収集
* **GitHub連携**: Issue検索、自動起票、PR生成
* **コマンド処理**: /ask、/clear、/help等のコマンドパース・実行

---

### 6. AI プロンプト（未実装）

```text
<system>
You are a bilingual support bot (JP/EN). Follow best practice.
Conversation (latest 6 messages):
{messages}
----
Knowledge:
{docs}
</system>
<user>
{current user input}
```

* 追加の会話コンテキストはベクター検索で動的注入 → トークン数を可視的に節約
* システム側で `lang = detect(user_msg)` → 必要なら和訳・英訳を生成（Haiku 英日混在耐性あり）

---

### 7. レイテンシ最適化

| 区間             | 典型 p95                                 |
| ---------------- | ---------------------------------------- |
| Webhook → ACK    | **< 0.3 s**                              |
| DB読み書き       | **< 50 ms**                              |
| S3アップロード   | **< 200 ms** (画像・ファイル)            |

現在はAI処理が未実装のため、シンプルなチャット保存・取得のみで高速レスポンスを実現。

---

### 8. コストざっくり（月 1 万メッセージ）

| コンポーネント           | 月額目安        |
| ------------------------ | --------------- |
| API Gateway              | \$3.5           |
| Lambda                   | \$2             |
| DynamoDB (2テーブル)     | \$5             |
| S3                       | \$1             |
| **合計（現在）**         | **≈ \$11.5**    |

※ AI機能実装時は +\$25-30 程度の追加コストを想定

---

### 9. 運用とセキュリティ

1. **IAM 最小権限**：Lambda は必要なDynamoDBテーブル・S3バケットのみアクセス可
2. **認証・認可**：
   - Custom UI: JWT によるセッション管理（24時間有効）
   - ボットアクセス: owner/admin/member のロールベース制御
   - 招待機能: 有効期限付きの招待リンク
3. **データ保護**：
   - パスワード: bcrypt によるハッシュ化
   - チャット履歴: 24時間で自動削除（TTL）
   - S3: バケットポリシーで適切なアクセス制御
4. **プラットフォーム認証**：
   - Slack: Signing Secret による検証（※未実装）
   - LINE: Channel Secret による検証（※未実装）
   - Teams: セキュリティトークン検証（※未実装）

---

### 10. デプロイ手順 (SAM)

```bash
cd backend/chat-router
sam build
sam deploy --config-env dev \
  --parameter-overrides \
    Stage=dev \
    ChatHistoryTable=ChatHistory-dev \
    ChatAssetsBucket=chat-history-assets-dev \
    ChatbotSettingsTable=ChatbotSettingsDB-dev
```

* 環境変数でプラットフォーム別のシークレットを設定（本番環境では Secrets Manager 推奨）
* フロントエンドは別途デプロイ（React アプリケーション）

---
